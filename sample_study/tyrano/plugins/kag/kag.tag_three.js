$.three_pos=function(e){var t={};return arr_obj=e.split(","),1==arr_obj.length?(t.x=parseFloat(arr_obj[0]),t.y=parseFloat(arr_obj[0]),t.z=parseFloat(arr_obj[0])):(t.x=parseFloat(arr_obj[0]),t.y=parseFloat(arr_obj[1]),t.z=parseFloat(arr_obj[2])),t},$.setVector=function(e){var t={};return t.pos={x:e.position.x,y:e.position.y,z:e.position.z},t.rot={x:e.rotation.x,y:e.rotation.y,z:e.rotation.z},t.scale={x:e.scale.x,y:e.scale.y,z:e.scale.z},t},$.orgFloor=function(e,t){return Math.floor(e*t)/t},$.checkThreeModel=function(e){if(TYRANO.kag.tmp.three.models[e])return!0;alert("model「"+e+"」は未定義です。宣言してください。")},tyrano.plugin.kag.tag["3d_init"]={vital:[],pm:{layer:"0",page:"fore",camera:"Perspective",near:"1",far:"5000",next:"true"},clock:{},start:function(e){var t=this,a=this.kag.layer.getLayer(e.layer,e.page);if(this.clock=new THREE.Clock,$(".three_canvas").length>0)return void this.kag.ftag.nextOrder();var o=$("<canvas id='three' class='three_canvas'></canvas>"),r=parseInt(this.kag.config.scWidth),n=parseInt(this.kag.config.scHeight);o.css({position:"absolute",width:r,height:n}),a.append(o);const i=new THREE.WebGLRenderer({canvas:document.querySelector("#three"),alpha:!0,antialias:!0,preserveDrawingBuffer:!0});i.setPixelRatio(window.devicePixelRatio),i.setSize(r,n);const s=new THREE.Scene,l=e.camera+"Camera",p=new THREE[l](45,r/n,parseFloat(e.near),parseFloat(e.far));p.rotation.order="YXZ",p.position.set(0,0,1e3),this.kag.tmp.three.models.camera=new ThreeModel({name:"camera",model:p,mixer:null,gltf:null,pm:e},d),a.show();const g=new THREE.AmbientLight(16777215,1);s.add(g);const m=new THREE.DirectionalLight(16777215,1);s.add(m),this.kag.tmp.three.stat.is_load=!0,this.kag.tmp.three.stat.canvas_show=!0,this.kag.tmp.three.stat.init_pm=e,this.kag.tmp.three.camera=p,this.kag.tmp.three.scene=s,this.kag.tmp.three.renderer=i,this.kag.tmp.three.light_amb=g,this.kag.tmp.three.target_layer=a,this.kag.tmp.three.j_canvas=o;var d=this.kag.tmp.three;!function e(){d.orbit_controls&&d.orbit_controls.update();t.updateFrame();i.render(s,p);var a=requestAnimationFrame(e);0==d.stat.is_load&&window.cancelAnimationFrame(a)}();Math.random();this.initEvent(this.kag.tmp.three),"true"==e.next&&this.kag.ftag.nextOrder()},initEvent:function(e){var t=this,a=(e.renderer,e.target_layer,e.j_canvas),o=e.camera,r=e.scene;a.on("click",function(a){var n=a.clientX,i=a.clientY,s=new THREE.Vector2;s.x=n/window.innerWidth*2-1,s.y=-i/window.innerHeight*2+1;var l=new THREE.Raycaster;l.setFromCamera(s,o);var p=l.intersectObjects(r.children,!0);if(p.length>0){var g=p[0].object.userData.name;if(1==t.kag.stat.is_strong_stop&&e.evt[g])return t.kag.layer.showEventLayer(),void t.kag.ftag.startTag("jump",e.evt[g])}})},updateFrame:function(){var e=this.kag.tmp.three,t=e.camera,a=e.models,o=this.clock.getDelta();for(key in a)a[key].mixer&&a[key].update(o);1==e.stat.gyro.mode?(t.rotation.x=e.stat.gyro.x,t.rotation.y=e.stat.gyro.y):2==e.stat.gyro.mode&&(t.position.x=e.stat.gyro.x,t.position.y=e.stat.gyro.y)}},tyrano.plugin.kag.tag["3d_model_new"]={vital:["name","storage"],pm:{name:"",storage:"",pos:"0",rot:"0",scale:"100",tonemap:"true",motion:"",next:"true",folder:""},start:function(e){var t=this.kag.tmp.three,a="";a=""!=e.folder?e.folder:"others/3d/model";var o=$.getExt(e.storage);if("gltf"==o||"glb"==o){var r="./data/"+a+"/"+e.storage;(new THREE.GLTFLoader).load(r,a=>{var o=a,r=o.scene;let n=$.three_pos(e.pos),i=$.three_pos(e.scale),s=$.three_pos(e.rot);r.position.set(n.x,n.y,n.z),r.scale.set(i.x,i.y,i.z),r.rotation.set(s.x,s.y,s.z);const l=o.animations;let p=new THREE.AnimationMixer(r);if(l.length>0){let t=l[0];if(""!=e.motion)for(var g=0;g<l.length;g++){if(l[g].name==e.motion){t=l[g];break}}p.clipAction(t).play()}else p=void 0;this.kag.tmp.three.models[e.name]=new ThreeModel({name:e.name,model:r,mixer:p,gltf:o,pm:e},t),"true"==e.tonemap?this.kag.tmp.three.models[e.name].setToneMaped(!0):this.kag.tmp.three.models[e.name].setToneMaped(!1),"true"==e.next&&this.kag.ftag.nextOrder()})}else if("obj"==o){var n="./data/"+a+"/"+e.storage,i=n.replace(".obj",".mtl");(new THREE.MTLLoader).load(i,a=>{a.preload();var o=new THREE.OBJLoader;o.setMaterials(a),a.toneMaped=!1,o.load(n,a=>{var o=a;let r=$.three_pos(e.pos),n=$.three_pos(e.scale),i=$.three_pos(e.rot);o.position.set(r.x,r.y,r.z),o.scale.set(n.x,n.y,n.z),o.rotation.set(i.x,i.y,i.z),this.kag.tmp.three.models[e.name]=new ThreeModel({name:e.name,model:o,pm:e},t),"true"==e.tonemap?this.kag.tmp.three.models[e.name].setToneMaped(!0):this.kag.tmp.three.models[e.name].setToneMaped(!1),"true"==e.next&&this.kag.ftag.nextOrder()})})}else"mmd"==o||alert("エラー："+o+"はサポートしていないファイル形式です")}},tyrano.plugin.kag.tag["3d_sphere_new"]={vital:["name"],pm:{name:"",type:"SphereGeometry",texture:"",color:"0x00ff00",radius:"300",width:"30",height:"30",scale:"1",pos:"0",rot:"0",folder:""},start:function(e){e.arg1=e.radius,e.arg2=e.width,e.arg3=e.height,this.kag.ftag.startTag("obj_model_new",e)}},tyrano.plugin.kag.tag["3d_sprite_new"]={vital:["name","storage"],pm:{name:"",storage:"",scale:"",pos:"0",rot:"0",tonemap:"false",next:"true",folder:""},start:function(e){var t="./data/"+(""!=e.folder?e.folder:"others/3d/sprite")+"/"+e.storage;const a=new THREE.SpriteMaterial({map:(new THREE.TextureLoader).load(t),alphaTest:.01,transparent:!0});"true"==e.tonemap?a.toneMapped=!0:a.toneMapped=!1;var o=new THREE.Sprite(a);$("<img />").attr("src",t).on("load",t=>{var a=$(t.currentTarget).get(0).width,r=$(t.currentTarget).get(0).height;let n=$.three_pos(e.pos),i=$.three_pos(e.rot);if(o.position.set(n.x,n.y,n.z),o.rotation.set(i.x,i.y,i.z),""==e.scale)o.scale.set(1*parseInt(a),1*parseInt(r),1);else{let t=$.three_pos(e.scale);o.scale.set(t.x,t.y,t.z)}var s=this.kag.tmp.three;s.scene;this.kag.tmp.three.models[e.name]=new ThreeModel({name:e.name,model:o,pm:e},s),"true"==e.next&&this.kag.ftag.nextOrder()})}},tyrano.plugin.kag.tag["3d_event"]={vital:["name"],pm:{name:"",storage:"",target:""},start:function(e){var t=this.kag.tmp.three;t.stat.start_event=!0,t.evt[e.name]=e,this.kag.ftag.nextOrder()}},tyrano.plugin.kag.tag["3d_event_delete"]={vital:["name"],pm:{name:""},start:function(e){delete this.kag.tmp.three.evt[e.name],this.kag.ftag.nextOrder()}},tyrano.plugin.kag.tag["3d_event_start"]={vital:[],pm:{},start:function(e){this.kag.tmp.three.stat.start_event=!0,this.kag.ftag.nextOrder()}},tyrano.plugin.kag.tag["3d_event_stop"]={vital:[],pm:{},start:function(e){this.kag.tmp.three.stat.start_event=!1,this.kag.ftag.nextOrder()}},tyrano.plugin.kag.tag["3d_box_new"]={vital:["name"],pm:{name:"",type:"BoxGeometry",texture:"",color:"0x00ff00",width:"1",height:"1",depth:"1",scale:"1",pos:"0",rot:"0",folder:""},start:function(e){e.arg1=e.width,e.arg2=e.height,e.arg3=e.depth,this.kag.ftag.startTag("obj_model_new",e)}},tyrano.plugin.kag.tag["3d_image_new"]={vital:["name","width"],pm:{name:"",type:"PlaneGeometry",texture:"",width:"",height:"",scale:"1",pos:"0",rot:"0",doubleside:"false",tonemap:"false"},start:function(e){if(""==e.height){var t="./data/others/3d/texture/"+e.texture;$("<img />").attr("src",t).on("load",t=>{var a=$(t.currentTarget).get(0).width,o=$(t.currentTarget).get(0).height/a;e.height=parseInt(parseInt(e.width)*o),e.arg1=e.width,e.arg2=e.height,e.arg3=1,this.kag.ftag.startTag("obj_model_new",e)})}else e.arg1=e.width,e.arg2=e.height,e.arg3=1,this.kag.ftag.startTag("obj_model_new",e)}},tyrano.plugin.kag.tag.obj_model_new={vital:["name","type"],pm:{name:"",type:"",texture:"",color:"",arg1:0,arg2:0,arg3:0,scale:"",pos:"",rot:"",doubleside:"false",tonemap:"true",motion:"",folder:"",next:"true"},start:function(e){var t=this.kag.tmp.three;t.scene;const a=new THREE[e.type](parseFloat(e.arg1),parseFloat(e.arg2),parseFloat(e.arg3));let o;if(""!=e.texture)if("BoxGeometry"==e.type&&e.texture.split(",").length>1){var r=e.texture.split(","),n=[];const t=new THREE.TextureLoader;for(let e=0;e<r.length;e++){var i="./data/others/3d/texture/"+r[e];const a=t.load(i);n.push(new THREE.MeshStandardMaterial({map:a}))}o=n}else{i="./data/others/3d/texture/"+e.texture;const t=(new THREE.TextureLoader).load(i);o=new THREE.MeshStandardMaterial({map:t,alphaTest:.01,transparent:!0})}else o=new THREE.MeshStandardMaterial({color:parseInt(e.color.toLowerCase())});"true"==e.doubleside&&(o.side=THREE.DoubleSide),"true"==e.tonemap?o.toneMapped=!0:o.toneMapped=!1;const s=new THREE.Mesh(a,o);let l=$.three_pos(e.pos),p=$.three_pos(e.scale),g=$.three_pos(e.rot);s.position.set(l.x,l.y,l.z),s.scale.set(p.x,p.y,p.z),s.rotation.set(g.x,g.y,g.z),this.kag.tmp.three.models[e.name]=new ThreeModel({name:e.name,model:s,pm:e},t),"true"==e.next&&this.kag.ftag.nextOrder()}},tyrano.plugin.kag.tag["3d_show"]={vital:["name"],pm:{name:"",time:"500",scale:"",pos:"",rot:"",wait:"true"},start:function(e){var t=this.kag.tmp.three;if(0!=$.checkThreeModel(e.name)){var a=this.kag.tmp.three.models[e.name];t.scene.add(a.model);var o={duration:parseInt(e.time)};if(""!=e.pos){let t=$.three_pos(e.pos);a.setPosition(t.x,t.y,t.z)}if(""!=e.scale){let t=$.three_pos(e.scale);a.setScale(t.x,t.y,t.z)}if(""!=e.rot){let t=$.three_pos(e.rot);a.setRotation(t.x,t.y,t.z)}"true"==e.wait?a.fade("in",o,()=>{this.kag.ftag.nextOrder()}):(a.fade("in",o),this.kag.ftag.nextOrder())}}},tyrano.plugin.kag.tag["3d_hide"]={vital:["name"],pm:{name:"",time:"500",next:"true",wait:"true"},start:function(e){if(0!=$.checkThreeModel(e.name)){var t=this.kag.tmp.three,a={duration:parseInt(e.time)},o=this.kag.tmp.three.models[e.name];"true"==e.wait?o.fade("out",a,e=>{this.kag.ftag.nextOrder(),t.scene.remove(e)}):(o.fade("out",a,e=>{t.scene.remove(e)}),this.kag.ftag.nextOrder())}}},tyrano.plugin.kag.tag["3d_hide_all"]={vital:[],pm:{time:"500",wait:"true"},start:function(e){var t=this.kag.tmp.three,a={duration:parseInt(e.time)},o=this.kag.tmp.three.models,r=0,n=0;for(let i in o)"camera"!=i&&(r++,"true"==e.wait?o[i].fade("out",a,e=>{t.scene.remove(e),r==++n&&this.kag.ftag.nextOrder()}):(o[i].fade("out",a,e=>{t.scene.remove(e),n++}),this.kag.ftag.nextOrder()));0==r&&this.kag.ftag.nextOrder()}},tyrano.plugin.kag.tag["3d_delete"]={vital:["name"],pm:{name:""},start:function(e){if(0!=$.checkThreeModel(e.name)){var t=this.kag.tmp.three,a=this.kag.tmp.three.models[e.name];t.scene.remove(a.model),delete this.kag.tmp.three.models[e.name],this.kag.ftag.nextOrder()}}},tyrano.plugin.kag.tag["3d_delete_all"]={vital:[],pm:{},start:function(e){var t=this.kag.tmp.three,a=this.kag.tmp.three.models;for(let e in a)if("camera"!=e){var o=a[e];t.scene.remove(o.model),delete t.models[e]}this.kag.ftag.nextOrder()}},tyrano.plugin.kag.tag["3d_canvas_show"]={vital:[],pm:{time:"1000"},start:function(e){var t=this.kag.tmp.three;this.kag.tmp.three.stat.canvas_show=!0,t.j_canvas.fadeIn(parseInt(e.time),()=>{this.kag.ftag.nextOrder()})}},tyrano.plugin.kag.tag["3d_canvas_hide"]={vital:[],pm:{time:"1000"},start:function(e){var t=this.kag.tmp.three;this.kag.tmp.three.stat.canvas_show=!1,t.j_canvas.fadeOut(parseInt(e.time),()=>{this.kag.ftag.nextOrder()})}},tyrano.plugin.kag.tag["3d_close"]={vital:[],pm:{},start:function(e){var t=this.kag.tmp.three;t.stat.is_load=!1,t.stat.canvas_show=!1,t.j_canvas&&t.j_canvas.remove(),this.kag.ftag.nextOrder()}},tyrano.plugin.kag.tag["3d_anim"]={vital:["name"],pm:{name:"",time:"1000",effect:"linear",pos:"",rot:"",scale:"",lookat:"",wait:"true"},start:function(e){if(0!=$.checkThreeModel(e.name)){var t=this.kag.tmp.three,a={duration:parseInt(e.time),easing:e.effect},o={};if(""!=e.pos)if("camera"==e.name&&""!=e.lookat)if(t.models[e.lookat]){var r=t.models[e.lookat].model;(s={x:0,y:0,z:0}).x=r.position.x,s.y=r.position.y,s.z=r.position.z,o.position=s}else o.position=$.three_pos(e.lookat);else o.position=$.three_pos(e.pos);""!=e.rot&&(o.rotation=$.three_pos(e.rot)),""!=e.scale&&(o.scale=$.three_pos(e.scale));var n=0,i=Object.keys(o).length;for(let t in o){var s=o[t],l=t;this.kag.tmp.three.models[e.name].toAnim(l,s,a,()=>{++n>=i&&"true"==e.wait&&this.kag.ftag.nextOrder()})}"true"!=e.wait&&this.kag.ftag.nextOrder()}}},tyrano.plugin.kag.tag["3d_anim_stop"]={vital:["name"],pm:{name:"",finish:"true"},start:function(e){if(0!=$.checkThreeModel(e.name)){this.kag.tmp.three;this.kag.tmp.three.models[e.name].stopAnim(e.finish),this.kag.ftag.nextOrder()}}},tyrano.plugin.kag.tag["3d_scene"]={vital:[],pm:{tonemap:"",tonemap_value:"0.8",light_amb:"",fog:"",fog_range:"1,3000",fog_color:"0xFFFFFF",next:"true"},start:function(e){var t=this.kag.tmp.three,a=t.scene,o=(t.camera,t.renderer);if(""!=e.light_amb&&(t.stat.scene_pm.light_amb=e.light_amb,t.light_amb.intensity=parseFloat(e.light_amb)),""!=e.tonemap){t.stat.scene_pm.tonemap=e.tonemap,o.toneMapping=THREE[e.tonemap+"ToneMapping"],o.toneMappingExposure=parseFloat(e.tonemap_value);for(let e in t.models)t.models[e].needsUpdate()}if(""!=e.fog)if("true"==e.fog){t.stat.scene_pm.fog=e.fog,t.stat.scene_pm.fog_color=e.fog_color,t.stat.scene_pm.fog_range=e.fog_range;var r=e.fog_range.split(",");a.fog=new THREE.Fog(parseInt(e.fog_color),parseFloat(r[0]),parseFloat(r[1]))}else t.stat.scene_pm.fog,a.fog.near=.1,a.fog.far=0;"true"==e.next&&this.kag.ftag.nextOrder()}},tyrano.plugin.kag.tag["3d_camera"]={vital:[],pm:{pos:"",rot:"",lookat:"",next:"true"},start:function(e){var t=this.kag.tmp.three,a=t.camera;t.renderer;if(""!=e.pos){let t=$.three_pos(e.pos);a.position.set(t.x,t.y,t.z)}if(""!=e.rot){let t=$.three_pos(e.rot);a.rotation.set(t.x,t.y,t.z)}if(""!=e.lookat){var o={x:0,y:0,z:0};if(t.models[e.lookat]){var r=TYRANO.kag.tmp.three.models[e.lookat].model;o.x=r.position.x,o.y=r.position.y,o.z=r.position.z}else o=$.three_pos(e.lookat);a.lookAt(new THREE.Vector3(o.x,o.y,o.z))}"true"==e.next&&this.kag.ftag.nextOrder()}},tyrano.plugin.kag.tag["3d_gyro"]={vital:[],pm:{max_x:"30",max_y:"30",mode:"rotation",next:"true"},start:function(e){var t=this.kag.tmp.three,a=t.camera;t.renderer;{const o=o=>{var r=0,n=0,i=!0,s=parseFloat(e.max_y),l=parseFloat(e.max_x),p=a.rotation.y,g=a.rotation.x,m=a.position.y,d=a.position.x,c=0;parseInt(e.frame);t.stat.gyro.pm=e;const h=a=>{if(1==i&&(i=!1,r=a.beta,n=a.gamma,c=this.kag.tmp.angle,"rotation"==e.mode?t.stat.gyro.mode=1:t.stat.gyro.mode=2,0!=c?[l,s]=[s,l]:(l=e.max_x,s=e.max_y)),c==this.kag.tmp.angle){if(0!=c){var o=a.gamma;if(-90==c){if(o<0)return}else if(90==c&&o>0)return}var h=r-a.beta,u=n-a.gamma;Math.abs(h)>s&&(h=h>0?s:-1*s),Math.abs(u)>l&&(u=u>0?l:-1*l);var v=0,f=0;1==t.stat.gyro.mode?0==c?(f=g-u*(Math.PI/180),v=p-h*(Math.PI/180)):-90==c?(f=p+h*(Math.PI/180),v=g-u*(Math.PI/180)):90==c&&(f=p+-1*h*(Math.PI/180),v=g- -1*u*(Math.PI/180)):2==t.stat.gyro.mode&&(0==c?(v=m+10*u,f=d+10*h):-90==c?(f=m+10*u,v=d+10*h):90==c&&(f=m+10*u,v=d+10*h)),t.stat.gyro.x=v,t.stat.gyro.y=f}else i=!0};var u=parseInt(this.kag.config.scWidth)/2,v=parseInt(this.kag.config.scHeight)/2;const f=a=>{var o=a.clientX,r=a.clientY,n=(o-=u)/u,s=(r=-1*(r-v))/v,l=parseFloat(e.max_x),c=parseFloat(e.max_y),h=0,f=0;1==i&&(i=!1,"rotation"==e.mode?t.stat.gyro.mode=1:t.stat.gyro.mode=2),1==t.stat.gyro.mode?(h=g+l*n*(Math.PI/180),f=p-c*s*(Math.PI/180)):2==t.stat.gyro.mode&&(f=d+l*n,h=m+c*s),t.stat.gyro.x=f,t.stat.gyro.y=h};"pc"==o?($(".tyrano_base").get(0).removeEventListener("mousemove",f),$(".tyrano_base").get(0).addEventListener("mousemove",f,!0)):(window.removeEventListener("deviceorientation",h),window.addEventListener("deviceorientation",h,!0))};(()=>{"pc"!=$.userenv()?DeviceMotionEvent&&("function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then(e=>{"granted"===e&&o("sp")}).catch(console.error):o("sp")):o("pc")})()}"true"==e.next&&this.kag.ftag.nextOrder()}},tyrano.plugin.kag.tag["3d_gyro_stop"]={vital:[],pm:{max_x:"30",max_y:"30",frame:"1",next:"true"},start:function(e){var t=this.kag.tmp.three;t.camera,t.renderer;t.stat.gyro.mode=0,this.kag.ftag.nextOrder()}},tyrano.plugin.kag.tag["3d_debug_camera"]={vital:[],pm:{name:"camera",button_text:"カメラインスペクタを閉じる",menu:"true"},start:function(e){var t=this.kag.tmp.three,a=t.j_canvas,o=t.target_layer,r=o.css("z-index"),n=a.css("z-index");a.css("z-index",9999999),o.css("z-index",9999999);var i=this.kag.tmp.three.models[e.name].model,s=t.renderer,l=(t.camera,parseInt(this.kag.config.scWidth),parseInt(this.kag.config.scHeight),!1),p=0,g=(new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,$.setVector(i)),m=0,d=0,c=0,h=0,u=0;function v(e){e.wheelDelta<0?i.position.z+=5:i.position.z-=5,y(),e.preventDefault()}function f(e){0==e.button?(p=0,m=e.clientX,d=e.clientY,c=i.rotation.x,h=i.rotation.y):1==e.button?(p=1,d=e.clientY,u=i.position.z):2==e.button&&(p=2,m=e.clientX,d=e.clientY,c=i.position.x,h=i.position.y),l=!0}function x(e){if(l)if(0==p){var t=m-e.clientX;i.rotation.y=h+.005*t;var a=d-e.clientY;i.rotation.x=c+.005*a}else if(1==p){a=d-e.clientY;i.position.z=u+a}else if(2==p){t=m-e.clientX;i.position.x=c+1*t;a=d-e.clientY;i.position.y=h+-1*a,i.position.x=$.orgFloor(i.position.x,1),i.position.y=$.orgFloor(i.position.y,1)}}function y(e){if(m=0,d=0,0==p)$.orgFloor(i.rotation.x,100),$.orgFloor(i.rotation.y,100),i.rotation.z;var t='pos="'+(i.position.x+","+i.position.y+","+i.position.z)+'" rot="'+($.orgFloor(i.rotation.x,100)+","+$.orgFloor(i.rotation.y,100)+","+$.orgFloor(i.rotation.z,100))+'" scale="'+($.orgFloor(i.scale.x,100)+","+$.orgFloor(i.scale.y,100)+","+$.orgFloor(i.scale.z,100))+'" ';_.find("input").val(t),l=!1}s.domElement.addEventListener("mousewheel",v,!1),s.domElement.addEventListener("mousedown",f,!1),s.domElement.addEventListener("mouseup",y,!1),s.domElement.addEventListener("mousemove",x,!1);var k=$("<div class='area_three_debug' style='position:absolute;z-index:9999999999;padding:10px;opacity:0.8;background-color:white;left:0px;top:0px'><button style='cursor:pointer'><span style=''>"+e.button_text+"</span></button></div>");k.draggable({scroll:!1,stop:(e,t)=>{}});var _=$("<div style='padding:5px'><input type='text' style='width:320px' /></div>"),w=$("<input type='button' value='コピー' />");w.on("click",e=>{y(),_.find("input").select(),document.execCommand("copy")});var E=$("<input type='button' value='リセット' />");E.on("click",e=>{i.position.set(g.pos.x,g.pos.y,g.pos.z),i.rotation.set(g.rot.x,g.rot.y,g.rot.z),i.scale.set(g.scale.x,g.scale.y,g.scale.z)}),k.find("button").on("click",e=>{k.remove(),a.css("z-index",n),o.css("z-index",r),s.domElement.removeEventListener("mousedown",f),s.domElement.removeEventListener("mouseup",y),s.domElement.removeEventListener("mousemove",x),s.domElement.removeEventListener("mousewheel",v),this.kag.ftag.nextOrder()}),"true"==e.menu&&(k.append("<span style='font-size:10px'>｜</span>"),k.append(w),k.append(E),k.append(_)),$("body").append(k)}},tyrano.plugin.kag.tag["3d_motion"]={vital:["name","motion"],pm:{name:"",motion:""},start:function(e){if(0!=$.checkThreeModel(e.name)){this.kag.tmp.three;this.kag.tmp.three.models[e.name].setMotion(e.motion),this.kag.ftag.nextOrder()}}},tyrano.plugin.kag.tag["3d_debug"]={vital:["name"],pm:{name:"",button_text:"3Dインスペクタを閉じる",menu:"true",overlap:"false",reset:"false"},start:function(e){var t=this.kag.tmp.three,a=t.j_canvas,o=t.target_layer,r=o.css("z-index"),n=a.css("z-index"),i=this.kag.tmp.three.models[e.name],s=i.model,l=(t.renderer,t.camera),p=(parseInt(this.kag.config.scWidth),parseInt(this.kag.config.scHeight),{}),g=!1,m=0,d=new THREE.Vector3,c=new THREE.Vector3,h=new THREE.Vector3,u={x:0,y:0,z:0},v=$.setVector(s),f=0,x=0;function y(e){e.wheelDelta<0?(s.scale.x-=.01*s.scale.x,s.scale.y-=.01*s.scale.y,s.scale.z-=.01*s.scale.z):(s.scale.x+=.01*s.scale.x,s.scale.y+=.01*s.scale.y,s.scale.z+=.01*s.scale.z),w(),e.preventDefault()}function k(e){if(0==e.button)m=0;else if(1==e.button)m=1,f=e.clientY,x=s.position.z;else if(2==e.button){m=2,d.set(e.clientX/window.innerWidth*2-1,-e.clientY/window.innerHeight*2+1,.5),d.unproject(l),d.sub(l.position).normalize();var t=0;t=l.position.z>0?-l.position.z/d.z:l.position.z/d.z,h.copy(l.position).add(d.multiplyScalar(t)),u.x=s.position.x-h.x,u.y=s.position.y-h.y}g=!0,p={x:e.clientX,y:e.clientY}}function _(e){if(g)if(b.hide(),0==m)moveDistance={x:p.x-e.clientX,y:p.y-e.clientY},s.rotation.x+=.01*moveDistance.y,s.rotation.y-=.01*moveDistance.x,p={x:e.clientX,y:e.clientY};else if(1==m){var t=f-e.clientY;s.position.z=x+t}else if(2==m){d.set(e.clientX/window.innerWidth*2-1,-e.clientY/window.innerHeight*2+1,.5),d.unproject(l),d.sub(l.position).normalize();var a=0;a=l.position.z>0?-l.position.z/d.z:l.position.z/d.z,c.copy(l.position).add(d.multiplyScalar(a)),s.position.x=$.orgFloor(u.x+c.x,1),s.position.y=$.orgFloor(u.y+c.y,1)}}function w(e){if(b.show(),0==m)$.orgFloor(s.rotation.x,100),$.orgFloor(s.rotation.y,100),s.rotation.z;var t=s.position.x+","+s.position.y+","+s.position.z,a=$.orgFloor(s.rotation.x,100)+","+$.orgFloor(s.rotation.y,100)+","+$.orgFloor(s.rotation.z,100),o=$.orgFloor(s.scale.x,100)+","+$.orgFloor(s.scale.y,100)+","+$.orgFloor(s.scale.z,100),r=i.pm;r.pos=t,r.rot=a,r.scale=o,i.pm=r;var n='pos="'+t+'" rot="'+a+'" scale="'+o+'" ';T.find("input").val(n),g=!1}"true"==e.overlap&&(a.css("z-index",9999999),o.css("z-index",9999999));var E=$("<div style='width:100%;height:100%;position:absolute;z-index:9999999;'></div>");$(".tyrano_base").append(E);var z=E.get(0);z.addEventListener("mousewheel",y,!1),z.addEventListener("mousedown",k,!1),z.addEventListener("mouseup",w,!1),z.addEventListener("mousemove",_,!1);var b=$("<div class='area_three_debug' style='position:absolute;z-index:9999999999;padding:10px;opacity:0.8;background-color:white;left:0px;top:0px'><button style='cursor:pointer'><span style=''>"+e.button_text+"</span></button></div>");b.draggable({scroll:!1,stop:(e,t)=>{}});var T=$("<div style='padding:5px'><input type='text' style='width:320px' /></div>"),F=$("<input type='button' value='コピー' />");F.on("click",e=>{w(),T.find("input").select(),document.execCommand("copy")});var M=$("<input type='button' value='リセット' />");M.on("click",e=>{s.position.set(v.pos.x,v.pos.y,v.pos.z),s.rotation.set(v.rot.x,v.rot.y,v.rot.z),s.scale.set(v.scale.x,v.scale.y,v.scale.z)}),b.find("button").on("click",t=>{E.remove(),"true"==e.reset&&M.trigger("click"),b.remove(),a.css("z-index",n),o.css("z-index",r),z.removeEventListener("mousedown",k),z.removeEventListener("mouseup",w),z.removeEventListener("mousemove",_),z.removeEventListener("mousewheel",y),this.kag.ftag.nextOrder()}),"true"==e.menu&&(b.append("<span>｜</span>"),b.append(F),b.append(M),b.append(T)),$("body").append(b),w()}};
